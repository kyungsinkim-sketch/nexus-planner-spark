-- Migration 015: Fix RLS policies, add indexes, restore 2025 data
-- Fixes: project update timeout, file_groups INSERT, calendar event update, 2025 data restore

-- =====================================================
-- 1. ADD GIN INDEX on projects.team_member_ids
-- Fixes: "statement timeout" on project update due to
-- RLS policy checking auth.uid()::uuid = ANY(team_member_ids)
-- =====================================================
CREATE INDEX IF NOT EXISTS idx_projects_team_member_ids
ON projects USING GIN (team_member_ids);

-- =====================================================
-- 2. ADD INSERT POLICY for file_groups
-- Fixes: "new row violates row-level security policy for table file_groups"
-- =====================================================
CREATE POLICY "Team members can create file groups" ON file_groups
    FOR INSERT WITH CHECK (
        project_id IN (
            SELECT id FROM projects
            WHERE auth.uid() = pm_id
               OR auth.uid()::uuid = ANY(team_member_ids)
               OR EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'ADMIN')
        )
    );

-- Also add UPDATE and DELETE policies for file_groups
CREATE POLICY "Team members can update file groups" ON file_groups
    FOR UPDATE USING (
        project_id IN (
            SELECT id FROM projects
            WHERE auth.uid() = pm_id
               OR auth.uid()::uuid = ANY(team_member_ids)
               OR EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'ADMIN')
        )
    );

CREATE POLICY "Team members can delete file groups" ON file_groups
    FOR DELETE USING (
        project_id IN (
            SELECT id FROM projects
            WHERE auth.uid() = pm_id
               OR auth.uid()::uuid = ANY(team_member_ids)
               OR EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'ADMIN')
        )
    );

-- =====================================================
-- 3. UPDATE calendar_events policies
-- Allow attendees to update events they're invited to
-- =====================================================
DROP POLICY IF EXISTS "Users can update own events" ON calendar_events;
CREATE POLICY "Users can update own or attending events" ON calendar_events
    FOR UPDATE USING (
        owner_id = auth.uid()
        OR auth.uid()::uuid = ANY(COALESCE(attendee_ids, '{}'::UUID[]))
        OR EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'ADMIN')
    );

-- =====================================================
-- 4. RESTORE 2025 SEED PROJECTS
-- Re-insert all projects with ON CONFLICT DO NOTHING
-- (safe to re-run - won't duplicate existing data)
-- =====================================================
INSERT INTO projects (id, title, client, status, type, priority,
    start_date, end_date, description, progress,
    pm_id, team_member_ids, last_activity_at,
    health_schedule, health_workload, health_budget,
    tasks_completed, tasks_total, budget, key_color
) VALUES
('10000000-0000-0000-0000-000000000001',
 '현대글로비스 메인영상 / 브랜드필름 제작', '현대글로비스', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-01-01', '2025-03-31', '현대글로비스 메인영상 및 브랜드필름 제작 프로젝트', 100,
 '00000000-0000-0000-0000-000000000001',
 ARRAY['00000000-0000-0000-0000-000000000001','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 12, 12, 250450000, '#002E6E'),

('10000000-0000-0000-0000-000000000002',
 '현대글로비스 2025 홍보영상 리뉴얼', '현대글로비스', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-01-01', '2025-02-28', '현대글로비스 홍보영상 리뉴얼 프로젝트', 100,
 '00000000-0000-0000-0000-000000000001',
 ARRAY['00000000-0000-0000-0000-000000000001','00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-02-28', 'ON_TRACK', 'BALANCED', 'HEALTHY', 6, 6, 27700000, '#1A3D7C'),

('10000000-0000-0000-0000-000000000003',
 '탄소발자국이 적은 지속 가능한 미국대두', 'US Soy', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-01-01', '2025-03-15', '미국대두 지속가능성 홍보영상 제작', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-03-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 8, 8, 80000000, '#4CAF50'),

('10000000-0000-0000-0000-000000000004',
 '국가대표 나라장터, 한계를 넘다', '조달청', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-02-01', '2025-04-30', '나라장터 홍보 캠페인 영상', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-04-30', 'ON_TRACK', 'BALANCED', 'HEALTHY', 7, 7, 45454545, '#1976D2'),

('10000000-0000-0000-0000-000000000005',
 'McCain Corporate Campaign', 'McCain', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-03-01', '2025-05-31', 'McCain 글로벌 기업 캠페인 영상 제작', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-05-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 6, 6, 56698000, '#D32F2F'),

('10000000-0000-0000-0000-000000000006',
 'HMG 배터리데이', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-03-01', '2025-04-15', '현대자동차그룹 배터리데이 행사 영상 제작', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000005']::UUID[],
 '2025-04-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 10, 10, 200000000, '#002C5F'),

('10000000-0000-0000-0000-000000000007',
 'WFP x HMG 다큐멘터리', 'WFP x 현대자동차그룹', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-05-01', '2025-08-31', 'WFP x 현대자동차그룹 다큐멘터리 영상 제작', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000005']::UUID[],
 '2025-08-31', 'ON_TRACK', 'OVERLOADED', 'TIGHT', 15, 15, 551200000, '#0066CC'),

('10000000-0000-0000-0000-000000000008',
 E'디에이치 브랜드 10주년 기념 헤리티지 영상 \'기억이 춤추는 공간\'', '현대건설', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-05-01', '2025-07-31', '디에이치 브랜드 10주년 기념 헤리티지 영상', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-07-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 10, 10, 171500000, '#00B388'),

('10000000-0000-0000-0000-000000000009',
 E'iH 22주년 헤리티지필름 \'기억이 피어나는 공간\'', '인천도시공사', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-06-01', '2025-08-31', 'iH 인천도시공사 22주년 헤리티지 필름', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-08-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 9, 9, 130000000, '#FF6F00'),

('10000000-0000-0000-0000-000000000010',
 E'현대자동차 셔클 홍보영상 \'Broaden your circle : Shucle\'', '현대자동차', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-07-01', '2025-09-30', '현대자동차 셔클 홍보영상', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-09-30', 'ON_TRACK', 'BALANCED', 'HEALTHY', 12, 12, 275813400, '#003580'),

('10000000-0000-0000-0000-000000000011',
 E'현대건설 네오리빙 홍보영상 \'Here, you compose life\'', '현대건설', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-07-01', '2025-10-15', '현대건설 네오리빙 홍보영상 제작', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-10-15', 'ON_TRACK', 'OVERLOADED', 'TIGHT', 14, 14, 299700000, '#00897B'),

('10000000-0000-0000-0000-000000000012',
 '광복 80주년 CSR캠페인', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-08-01', '2025-08-15', '광복 80주년 CSR 캠페인 영상', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000005']::UUID[],
 '2025-08-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 8, 8, 100000000, '#C62828'),

('10000000-0000-0000-0000-000000000013',
 'PYLER IR 영상 제작', 'PYLER', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-09-01', '2025-10-31', 'PYLER IR 영상 제작', 100,
 '00000000-0000-0000-0000-000000000004',
 ARRAY['00000000-0000-0000-0000-000000000004','00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-10-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 6, 6, 50000000, '#9C27B0'),

('10000000-0000-0000-0000-000000000014',
 '두바이 K 할랄 푸드', 'K-Halal', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-10-01', '2025-11-30', '두바이 K 할랄 푸드 홍보 영상', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-11-30', 'ON_TRACK', 'BALANCED', 'HEALTHY', 4, 4, 20672119, '#E91E63'),

('10000000-0000-0000-0000-000000000015',
 'UWB 기술 홍보 영상', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-11-01', '2025-12-31', 'UWB 기술 홍보 영상 제작', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000005']::UUID[],
 '2025-12-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 10, 10, 283690000, '#1565C0'),

('10000000-0000-0000-0000-000000000016',
 '현대위아 HEV 기능통합 냉각 시스템 기술영상', '현대위아', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-11-01', '2025-12-15', '현대위아 HEV 기능통합 냉각 시스템 기술영상', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-12-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 7, 7, 61000000, '#607D8B'),

('10000000-0000-0000-0000-000000000017',
 '현대 글로비스 오토벨 홍보영상', '현대글로비스', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-12-01', '2026-01-31', '현대글로비스 오토벨 홍보영상 제작', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2026-01-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 6, 6, 56500000, '#0D47A1'),

('10000000-0000-0000-0000-000000000018',
 '현대자동차 울산신공장 홍보영상', '현대자동차', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-12-01', '2026-02-28', '현대자동차 울산신공장 홍보영상 (선금)', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000005']::UUID[],
 '2026-01-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 5, 5, 186900000, '#263238'),

('10000000-0000-0000-0000-000000000019',
 '필러미학 행사 스케치 쇼츠 영상', '필러미학', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-12-01', '2025-12-31', '필러미학 행사 스케치 쇼츠 영상 제작', 100,
 '00000000-0000-0000-0000-000000000004',
 ARRAY['00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-12-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 3, 3, 15100000, '#FF9800'),

('10000000-0000-0000-0000-000000000020',
 '현대자동차그룹 제품PR 운영 (2025)', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-03-01', '2025-12-31', '현대자동차그룹 제품PR 운영비', 100,
 '00000000-0000-0000-0000-000000000001',
 ARRAY['00000000-0000-0000-0000-000000000001','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-12-31', 'ON_TRACK', 'OVERLOADED', 'HEALTHY', 20, 20, 1340764798, '#002C5F'),

('10000000-0000-0000-0000-000000000021',
 '기아 PV5 테크데이 (별도예산)', '현대자동차그룹/기아', 'COMPLETED', 'EXECUTION', 'HIGH',
 '2025-07-01', '2025-08-31', '기아 PV5 테크데이 별도 예산 프로젝트', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003','00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000005']::UUID[],
 '2025-08-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 10, 10, 324300000, '#05141F'),

('10000000-0000-0000-0000-000000000022',
 'Corporate Campaign (2025)', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-03-01', '2025-05-31', 'Corporate Campaign', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-05-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 8, 8, 47407820, '#37474F'),

('10000000-0000-0000-0000-000000000024',
 'POSM Creative Fee', 'POSM', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-02-01', '2025-03-31', 'POSM Creative Fee', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 3, 3, 21829500, '#795548'),

('10000000-0000-0000-0000-000000000025',
 'LG OLED EVO 시안비', 'LG', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-02-01', '2025-03-15', 'LG OLED EVO 시안비', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-03-15', 'ON_TRACK', 'BALANCED', 'HEALTHY', 2, 2, 20000000, '#A50034'),

('10000000-0000-0000-0000-000000000026',
 '현대 CSR 점프스쿨 미디어 수수료', '현대자동차그룹', 'COMPLETED', 'EXECUTION', 'LOW',
 '2024-12-01', '2025-01-31', '현대 CSR 점프스쿨 미디어 수수료', 100,
 '00000000-0000-0000-0000-000000000003',
 ARRAY['00000000-0000-0000-0000-000000000003']::UUID[],
 '2025-01-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 2, 2, 15500000, '#004D40'),

('10000000-0000-0000-0000-000000000027',
 '밥아저씨 하이브리드 앱 개발', '밥아저씨', 'COMPLETED', 'EXECUTION', 'LOW',
 '2024-12-01', '2025-02-28', '밥아저씨 하이브리드 앱 개발', 100,
 '00000000-0000-0000-0000-000000000004',
 ARRAY['00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-02-28', 'ON_TRACK', 'BALANCED', 'HEALTHY', 5, 5, 13500000, '#FF5722'),

('10000000-0000-0000-0000-000000000028',
 '현대자동차 베테랑 교실 미디어 수수료', '현대자동차', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-02-01', '2025-03-31', '현대자동차 베테랑 교실 미디어 수수료', 100,
 '00000000-0000-0000-0000-000000000004',
 ARRAY['00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 2, 2, 13000000, '#3F51B5'),

('10000000-0000-0000-0000-000000000029',
 '현대건설 광고제 출품료', '현대건설', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-12-01', '2025-12-31', '현대건설 광고제 출품료', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-12-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 2, 2, 13090000, '#00897B'),

('10000000-0000-0000-0000-000000000030',
 '배스킨라빈슨 바나나푸딩아이스크림 AI 영상', '배스킨라빈슨', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-05-01', '2025-06-30', '배스킨라빈슨 바나나푸딩아이스크림 AI 영상 잔금', 100,
 '00000000-0000-0000-0000-000000000004',
 ARRAY['00000000-0000-0000-0000-000000000004']::UUID[],
 '2025-06-30', 'ON_TRACK', 'BALANCED', 'HEALTHY', 3, 3, 11000000, '#E91E63'),

-- Split p31 into 3 individual projects
('10000000-0000-0000-0000-000000000032',
 '삼성전자 비딩', '삼성전자', 'COMPLETED', 'BIDDING', 'MEDIUM',
 '2025-02-01', '2025-03-31', '삼성전자 비딩 프로젝트', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 1, 1, 2000000, '#1565C0'),

('10000000-0000-0000-0000-000000000033',
 '환경부 중대시민재해방지법 모델 추가계약료', '환경부', 'COMPLETED', 'EXECUTION', 'MEDIUM',
 '2025-02-01', '2025-03-31', '환경부 모델 추가계약료', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 1, 1, 3000000, '#2E7D32'),

('10000000-0000-0000-0000-000000000034',
 'Bdan 런칭캠페인영상 기획비', 'Bdan', 'COMPLETED', 'EXECUTION', 'LOW',
 '2025-02-01', '2025-03-31', 'Bdan 런칭캠페인 기획비', 100,
 '00000000-0000-0000-0000-000000000002',
 ARRAY['00000000-0000-0000-0000-000000000002']::UUID[],
 '2025-03-31', 'ON_TRACK', 'BALANCED', 'HEALTHY', 1, 1, 1000000, '#F57C00')

ON CONFLICT (id) DO NOTHING;

-- =====================================================
-- 5. RESTORE PROJECT FINANCIALS
-- =====================================================
INSERT INTO project_financials (project_id, contract_amount, expenses, payment_status, notes) VALUES
('10000000-0000-0000-0000-000000000001', 250450000, 362370925, 'PAID', '실지출 초과'),
('10000000-0000-0000-0000-000000000002', 27700000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000003', 80000000, 29265109, 'PAID', NULL),
('10000000-0000-0000-0000-000000000004', 45454545, 12874160, 'PAID', NULL),
('10000000-0000-0000-0000-000000000005', 56698000, 9211745, 'PAID', NULL),
('10000000-0000-0000-0000-000000000006', 200000000, 6242562, 'PAID', NULL),
('10000000-0000-0000-0000-000000000007', 551200000, 330091505, 'PAID', NULL),
('10000000-0000-0000-0000-000000000008', 171500000, 90533579, 'PAID', NULL),
('10000000-0000-0000-0000-000000000009', 130000000, 50204740, 'PAID', NULL),
('10000000-0000-0000-0000-000000000010', 275813400, 138051192, 'PAID', NULL),
('10000000-0000-0000-0000-000000000011', 299700000, 189232790, 'PAID', NULL),
('10000000-0000-0000-0000-000000000012', 100000000, 19734836, 'PAID', NULL),
('10000000-0000-0000-0000-000000000013', 50000000, 14001371, 'PAID', NULL),
('10000000-0000-0000-0000-000000000014', 20672119, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000015', 283690000, 95250936, 'PAID', NULL),
('10000000-0000-0000-0000-000000000016', 61000000, 7510603, 'PAID', NULL),
('10000000-0000-0000-0000-000000000017', 56500000, 12508800, 'PAID', NULL),
('10000000-0000-0000-0000-000000000018', 186900000, 0, 'PAID', '선금'),
('10000000-0000-0000-0000-000000000019', 15100000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000020', 1340764798, 0, 'PAID', '제품PR 운영'),
('10000000-0000-0000-0000-000000000021', 324300000, 0, 'PAID', 'PV5 테크데이'),
('10000000-0000-0000-0000-000000000022', 47407820, 0, 'PAID', 'Corporate Campaign'),
('10000000-0000-0000-0000-000000000024', 21829500, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000025', 20000000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000026', 15500000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000027', 13500000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000028', 13000000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000029', 13090000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000030', 11000000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000032', 2000000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000033', 3000000, 0, 'PAID', NULL),
('10000000-0000-0000-0000-000000000034', 1000000, 0, 'PAID', NULL)
ON CONFLICT (project_id) DO NOTHING;

-- =====================================================
-- 6. ADD 박민규, 백송희, 정형화 to all seed projects
-- =====================================================
DO $$
DECLARE
  proj RECORD;
  minkyu_id UUID := '00000000-0000-0000-0000-000000000003';
  songhee_id UUID := '00000000-0000-0000-0000-000000000004';
  hyunghwa_id UUID;
BEGIN
  SELECT id INTO hyunghwa_id FROM profiles WHERE name = '정형화' LIMIT 1;

  FOR proj IN
    SELECT id, team_member_ids FROM projects
    WHERE id::text LIKE '10000000-0000-0000-0000-%'
  LOOP
    DECLARE
      new_members UUID[] := COALESCE(proj.team_member_ids, '{}'::UUID[]);
    BEGIN
      IF NOT (minkyu_id = ANY(new_members)) THEN
        new_members := array_append(new_members, minkyu_id);
      END IF;
      IF NOT (songhee_id = ANY(new_members)) THEN
        new_members := array_append(new_members, songhee_id);
      END IF;
      IF hyunghwa_id IS NOT NULL AND NOT (hyunghwa_id = ANY(new_members)) THEN
        new_members := array_append(new_members, hyunghwa_id);
      END IF;
      UPDATE projects SET team_member_ids = new_members WHERE id = proj.id;
    END;
  END LOOP;
END $$;
