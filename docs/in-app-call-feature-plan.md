# In-App Call Feature — 기획안

> 채팅 내 음성/영상 통화 + 자동 녹음 + RAG 시딩

## 1. 왜 이게 정답인가

| 문제 | 기존 접근 (시스템 전화) | In-App Call |
|------|----------------------|-------------|
| iOS 녹음 | ❌ Apple 차단 | ✅ 앱 내 통화라 자유 |
| 화자 식별 | ❌ AI 추론 필요 | ✅ 유저 ID로 자동 |
| 다자 통화 | ❌ 불가 | ✅ 그룹콜 |
| 영상 통화 | ❌ 불가 | ✅ WebRTC |
| 데이터 주권 | ⚠️ 통신사 경유 | ✅ P2P 또는 우리 서버 |
| RAG 연동 | 수동 업로드 필요 | 자동 파이프라인 |

## 2. 기술 스택

### WebRTC (Best Choice)

```
WebRTC = 브라우저/앱 내 실시간 음성+영상 통화 프로토콜

장점:
- 오픈소스, 무료
- P2P (서버 부담 최소)
- 브라우저 + Tauri 모두 지원
- 음성 + 영상 + 화면공유 다 됨
- 녹음 완전 제어 가능
```

### 필요한 서버 인프라

```
┌──────────────┐
│ Signaling    │  ← WebSocket (Supabase Realtime으로 대체 가능!)
│ Server       │  
└──────────────┘
       │
┌──────┴──────┐
│ TURN/STUN   │  ← NAT 통과용 (Cloudflare TURN 무료)
│ Server      │  
└─────────────┘
       │
  ┌────┴────┐
  │  P2P    │  ← 실제 미디어는 P2P로 직접 전송
  │ Stream  │
  └─────────┘
```

**핵심**: Supabase Realtime을 Signaling으로 쓰면 **추가 서버 0개**.

## 3. Feature Breakdown

### 3.1 음성 통화 (Voice Call)

```
┌─────────────────────────────────────────┐
│           Re-Be.io Chat                  │
├─────────────────────────────────────────┤
│  [💬 메시지들...]                        │
│                                          │
│  ┌─────────────────────────────────┐    │
│  │  📞 통화 중 (02:34)              │    │
│  │  👤 김경신 (대표) — 🔊 말하는 중   │    │
│  │  👤 정승채 (경영실장) — 🔇        │    │
│  │  👤 Saffaan (CD) — 🔇            │    │
│  │                                   │    │
│  │  🔴 녹음 중                       │    │
│  │  [🎤 음소거] [📞 종료] [➕ 초대]  │    │
│  └─────────────────────────────────┘    │
│                                          │
│  [메시지 입력...]                        │
└─────────────────────────────────────────┘
```

**복잡도**: ⭐⭐ (WebRTC 기본)
**구현 기간**: 2-3주

### 3.2 영상 통화 (Video Call)

```
┌─────────────────────────────────────────┐
│  ┌───────────────────────────────────┐  │
│  │                                   │  │
│  │     👤 김경신 (메인 화면)          │  │
│  │                                   │  │
│  │  ┌─────┐  ┌─────┐  ┌─────┐      │  │
│  │  │정승채│  │Saffa│  │ 나  │      │  │
│  │  └─────┘  └─────┘  └─────┘      │  │
│  │                                   │  │
│  │  🔴 녹음 중  02:34               │  │
│  │  [🎤] [📷] [🖥️ 화면공유] [📞 종료]│  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**복잡도**: ⭐⭐⭐ (WebRTC + 다자 영상 레이아웃)
**구현 기간**: 3-4주 (음성 통화 위에 추가)

### 3.3 화면 공유 (Screen Share)

```
WebRTC의 getDisplayMedia() API로 구현
- 데스크탑: 전체 화면 / 앱 / 탭 선택
- 모바일: 화면 공유 (Android/iOS 모두 지원)
```

**복잡도**: ⭐⭐ (WebRTC 내장 기능)
**추가 기간**: +1주

## 4. 자동 녹음 → RAG 파이프라인

```
┌─────────────┐
│ 통화 시작    │
│ (WebRTC)    │
└──────┬──────┘
       │
       ▼
┌─────────────┐    ← MediaRecorder API
│ 서버 측 녹음  │    ← 각 참가자별 트랙 분리 녹음
│ (믹싱 없음)  │
└──────┬──────┘
       │
       ▼ 통화 종료 시
┌─────────────┐
│ 트랙 병합    │    ← 화자별 타임스탬프 자동 기록
│ + 타임스탬프  │    ← user_id로 화자 확정 (AI 추론 불필요!)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ STT 변환    │    ← Google STT (화자 분리 필요 없음!)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Brain 분석   │    ← Claude: 결정/할일/일정/핵심발언 추출
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│              자동 RAG 시딩                │
│                                          │
│  📋 결정사항 → decision_pattern          │
│  ✅ 할 일 → todo items                  │
│  📅 일정 → calendar events              │
│  💬 핵심 발언 → key_quotes              │
│  📝 회의록 → context                    │
│                                          │
│  각 항목에 화자(user_id) 자동 태깅       │
└─────────────────────────────────────────┘
```

### 화자 식별의 혁신

기존: `Speaker 1`, `Speaker 2` → AI가 추측
**In-App**: `김경신(CEO)`, `정승채(경영실장)` → **확정**

이게 RAG 품질을 근본적으로 바꿈:
- "김경신 대표가 예산 관련 결정을 내린 패턴" 검색 가능
- "정승채가 보고한 리스크 패턴" 추출 가능
- 프로젝트별 + 역할별 + 개인별 knowledge_items 정확 분류

## 5. Supabase Realtime as Signaling

```typescript
// 기존 Supabase Realtime을 활용 — 추가 서버 0개!

// 통화 시작 (Signaling)
const channel = supabase.channel(`call:${projectId}`)
  .on('broadcast', { event: 'offer' }, handleOffer)
  .on('broadcast', { event: 'answer' }, handleAnswer)
  .on('broadcast', { event: 'ice-candidate' }, handleIceCandidate)
  .on('broadcast', { event: 'call-ended' }, handleCallEnded)
  .subscribe();

// SDP Offer 전송
channel.send({
  type: 'broadcast',
  event: 'offer',
  payload: { sdp, from: userId, to: targetUserId }
});
```

## 6. 비용 분석

| 항목 | 비용 | 비고 |
|------|------|------|
| Signaling | $0 | Supabase Realtime (기존 인프라) |
| TURN | $0 | Cloudflare TURN (무료 tier) |
| 미디어 | $0 | P2P 직접 전송 |
| STT | ~$0.48/20분 | Google Cloud (통화 후 1회) |
| Brain 분석 | ~$0.03 | Claude Haiku |
| RAG 임베딩 | ~$0.001 | Voyage AI |
| **Total** | **~$0.51/통화** | 실시간 비용 $0, 분석만 유료 |

**1:1 통화 시**: 추가 서버 비용 $0 (P2P)
**다자 통화 시**: SFU 서버 필요 → Phase 2에서 고려

## 7. 구현 로드맵

### Phase A: 1:1 음성 통화 (2-3주)
```
Week 1: WebRTC + Supabase Signaling 연결
Week 2: 자동 녹음 + STT 파이프라인
Week 3: UI 완성 + 테스트
```
- P2P 직접 연결 (서버 비용 $0)
- 채팅방에서 📞 버튼으로 통화 시작
- 통화 종료 → 자동 분석 → RAG 시딩
- **iOS + Android + Desktop 모두 동작**

### Phase B: 다자 음성 통화 (+1-2주)
```
- WebRTC mesh (3-4명까지)
- 참가자별 트랙 분리 녹음
- 초대 링크로 팀원 추가
```

### Phase C: 영상 통화 (+2-3주)
```
- 카메라 스트림 추가
- 다자 영상 레이아웃 (Grid/Speaker view)
- 화면 공유
```

### Phase D: 고급 기능 (+2-3주)
```
- SFU 서버 (5명+ 다자 통화)
- 실시간 자막 (Streaming STT)
- 통화 중 AI 요약 (실시간)
- 녹화 (영상)
```

## 8. 경쟁 우위

| 기능 | Zoom/Teams | Re-Be.io |
|------|-----------|----------|
| 통화 | ✅ | ✅ |
| 녹음 | ✅ | ✅ 자동 |
| 회의록 | ❌ (유료 애드온) | ✅ 자동 |
| 할일 추출 | ❌ | ✅ 자동 |
| 일정 추출 | ❌ | ✅ 자동 |
| 개인 RAG 시딩 | ❌ | ✅ 자동 |
| 화자별 판단 추적 | ❌ | ✅ (user_id 확정) |
| 데이터 주권 | ❌ (외부 서버) | ✅ (P2P + 자체 서버) |

## 9. 핵심 Sales Pitch 업데이트

> **"Re-Be.io에서 통화하면, 통화가 끝나는 순간 회의록, 할 일, 일정이 자동으로 정리됩니다. Zoom에서는 절대 안 되는 일."**

## 10. 복잡도 평가

| 항목 | 복잡도 | 이유 |
|------|--------|------|
| 1:1 음성 통화 | ⭐⭐ | WebRTC 표준 구현 |
| 자동 녹음 | ⭐ | MediaRecorder API |
| Signaling | ⭐ | Supabase Realtime 활용 |
| 다자 통화 (3-4명) | ⭐⭐⭐ | Mesh 연결 관리 |
| 영상 통화 | ⭐⭐ | 카메라 스트림 추가 |
| 화면 공유 | ⭐⭐ | getDisplayMedia |
| SFU (5명+) | ⭐⭐⭐⭐ | 미디어 서버 필요 |
| 실시간 자막 | ⭐⭐⭐⭐ | Streaming STT |

**결론: 1:1 음성 + 영상은 충분히 구현 가능. 다자(3-4명)까지도 Mesh로 커버. 5명+는 SFU 서버가 필요해서 Phase D.**
